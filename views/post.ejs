<%# ---------------------------------------------------------
    post.ejs: 게시글 상세 + 댓글 보기 뷰
content: { no, title, content, created_at, name, user_id }
comments: [{ id, content, user_id, created_at, commenter }]
loginUserId, loginUserName: 세션 정보
--------------------------------------------------------- %>
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <%# 문서 제목으로 게시글 제목 사용 %>
  <title><%= content.title %> - MIDAS</title>
  <!-- Bootstrap CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css"
    rel="stylesheet"
    crossorigin="anonymous"
  >
  <link rel="stylesheet" href="/style.css">
</head>
<body>
  <%# 공통 내비게이션 바 %>
  <%- include('nav') %>

  <div class="container w-75 m-auto my-4">
    <!-- ① 게시글 제목 -->
    <h2 class="mt-4"><%= content.title %></h2>
    <!-- ② 작성자 및 작성일 -->
    <div class="text-secondary mb-3">
      작성자: <%= content.name %> |
      작성일: <%= content.created_at.toISOString().slice(0,19).replace('T',' ') %>
    </div>
    <!-- ③ 본문 -->
    <div class="bg-light p-4 rounded shadow-sm mb-4 dark-text">
      <%= content.content %>
    </div>
    <!-- ④ 수정/삭제 버튼: 본인 글만 보임 -->
    <div class="mb-4 text-end">
      <%# 🔧 수정1: String() 추가로 타입 통일 (숫자 vs 문자열 비교 문제 해결) %>
      <% if (String(content.user_id) === String(loginUserId)) { %>
        <%# 🔧 수정2: 버튼 색상 변경 (outline-dark → outline-primary) %>
        <a href="/board/<%= content.no %>/edit" class="btn btn-outline-primary btn-sm">수정</a>
        <%# 🔧 수정3: 삭제 버튼 추가 (Bootstrap 모달 트리거) %>
        <button type="button" class="btn btn-outline-danger btn-sm ms-2" 
                data-bs-toggle="modal" data-bs-target="#deleteModal">삭제</button>
      <% } %>
      <a href="/board" class="btn btn-outline-dark btn-sm ms-2">목록으로</a>
    </div>

    <%# 🔧 수정4: 삭제 확인 모달 추가 (적절한 위치에 배치) %>
    <!-- 삭제 확인 모달 -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">게시글 삭제</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            정말로 이 게시글을 삭제하시겠습니까?<br>
            삭제된 게시글은 복구할 수 없습니다.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
            <%# method-override를 사용한 DELETE 요청 %>
            <form action="/board/<%= content.no %>?_method=DELETE" method="POST" class="d-inline">
              <button type="submit" class="btn btn-danger">삭제</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ⑤ 댓글 섹션 -->
    <div class="mb-2"><strong>댓글</strong></div>
    <!-- ⑤-1 댓글 쓰기 폼 (로그인 시만) -->
    <% if (loginUserName) { %>
      <div class="mb-4 p-3 bg-light rounded shadow-sm">
        <form action="/comments" method="POST">
          <%# postNo 필드에 게시글 no (PK) 전달 %>
          <input type="hidden" name="postNo" value="<%= content.no %>">
          <div class="form-floating mb-2">
            <textarea
              class="form-control"
              id="floatingComment"
              name="content"
              placeholder="댓글을 입력하세요"
              style="height: 80px"
              required
            ></textarea>
            <label for="floatingComment">댓글 작성</label>
          </div>
          <div class="text-end">
            <button class="btn btn-secondary btn-sm">등록</button>
          </div>
        </form>
      </div>
    <% } %>

    <!-- ⑤-2 댓글 목록 -->
    <ul class="list-unstyled">
      <% comments.forEach(cmt => { %>
        <%# 🔧 수정5: 댓글 구조 변경 - 삭제 버튼을 위한 flex 레이아웃 %>
        <li class="mb-3 p-3 bg-light rounded shadow-sm dark-text">
          <div class="d-flex justify-content-between align-items-start mb-1">
            <div>
              <strong><%= cmt.commenter %></strong>
              <span class="text-secondary ms-2">
                <%= cmt.created_at.toISOString().slice(0,19).replace('T',' ') %>
              </span>
            </div>
            <%# 🔧 수정6: 댓글 삭제 버튼 추가 (본인 댓글만 보임) %>
            <!-- 댓글 삭제 버튼 (본인 댓글만) -->
            <% if (String(cmt.user_id) === String(loginUserId)) { %>
              <form action="/comments/<%= cmt.id %>?_method=DELETE" method="POST" class="d-inline">
                <button type="submit" class="btn btn-outline-danger btn-sm" 
                        onclick="return confirm('이 댓글을 삭제하시겠습니까?')">삭제</button>
              </form>
            <% } %>
          </div>
          <div><%= cmt.content %></div>
        </li>
      <% }) %>
      <% if (comments.length === 0) { %>
        <li class="text-secondary dark-text">등록된 댓글이 없습니다.</li>
      <% } %>
    </ul>
  </div>

  <!-- Bootstrap JS -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"
  ></script>
</body>
</html>